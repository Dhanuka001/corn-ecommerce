name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare SSH (key + known_hosts)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci
          PORT="${{ secrets.VPS_SSH_PORT }}"
          [ -z "$PORT" ] && PORT=22
          ssh-keyscan -p "$PORT" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH (down + build + force-recreate)
        env:
          VPS_HOST:     ${{ secrets.VPS_HOST }}
          VPS_USER:     ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_APP_DIR:  ${{ secrets.VPS_APP_DIR }}   # e.g. /opt/app
          GIT_BRANCH:   ${{ secrets.GIT_BRANCH }}    # optional; defaults to main
        run: |
          PORT="${VPS_SSH_PORT:-22}"

          # Pass variables into the remote shell; provide safe defaults
          ssh -i ~/.ssh/id_ci -o StrictHostKeyChecking=yes -p "$PORT" \
            "$VPS_USER@$VPS_HOST" \
            "VPS_APP_DIR='${VPS_APP_DIR:-/opt/app}' GIT_BRANCH='${GIT_BRANCH:-main}' bash -s" <<'EOF'
          set -euo pipefail

          # Safe defaults even with `set -u`
          : "${VPS_APP_DIR:=/opt/app}"
          : "${GIT_BRANCH:=main}"

          echo "[1/6] Pulling latest code for branch: $GIT_BRANCH"
          cd "$VPS_APP_DIR"
          git fetch origin "$GIT_BRANCH"
          git reset --hard "origin/$GIT_BRANCH"

          echo "[2/6] Moving to infra folder"
          cd "$VPS_APP_DIR/infra"

          echo "[3/6] Stopping old stack (prevents name conflicts)"
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          docker network rm corn-ecommerce_web || true

          echo "[4/6] Building images"
          docker compose -f docker-compose.prod.yml build

          echo "[5/6] Starting stack (force recreate + remove orphans)"
          docker compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

          echo "[6/6] Applying Prisma migrations (safe)"
          if docker compose -f docker-compose.prod.yml ps backend >/dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml exec -T backend sh -lc \
              'npx prisma generate && npx prisma migrate deploy || true'
          fi

          echo "Status:"
          docker compose -f docker-compose.prod.yml ps
          EOF
