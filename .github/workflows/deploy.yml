name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-main
      cancel-in-progress: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare SSH (key + known_hosts)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci
          PORT="${{ secrets.VPS_SSH_PORT }}"
          [ -z "$PORT" ] && PORT=22
          ssh-keyscan -p "$PORT" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH (clean rebuild + restart)
        env:
          VPS_HOST:     ${{ secrets.VPS_HOST }}
          VPS_USER:     ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_APP_DIR:  ${{ secrets.VPS_APP_DIR }}   # /opt/app
          GIT_BRANCH:   ${{ secrets.GIT_BRANCH }}    # main
        run: |
          PORT="${VPS_SSH_PORT:-22}"

          ssh -i ~/.ssh/id_ci -o StrictHostKeyChecking=yes -p "$PORT" \
            "$VPS_USER@$VPS_HOST" \
            "VPS_APP_DIR='${VPS_APP_DIR:-/opt/app}' GIT_BRANCH='${GIT_BRANCH:-main}' bash -s" <<'EOF'
          set -euo pipefail

          : "${VPS_APP_DIR:=/opt/app}"
          : "${GIT_BRANCH:=main}"
          PROJECT_NAME="corn-ecommerce"
          COMPOSE_FILE="$VPS_APP_DIR/infra/docker-compose.prod.yml"

          echo "[1/7] Stopping existing stack (if any)"
          if [ -f "$COMPOSE_FILE" ]; then
            docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" down --remove-orphans || true
          fi

          echo "[2/7] Cleaning app directory"
          if command -v sudo >/dev/null 2>&1; then
            sudo chown -R "$VPS_USER":"$VPS_USER" "$VPS_APP_DIR" || true
            sudo rm -rf "$VPS_APP_DIR"
          else
            rm -rf "$VPS_APP_DIR"
          fi

          echo "[3/7] Cloning fresh repository"
          git clone -b "$GIT_BRANCH" https://github.com/Dhanuka001/corn-ecommerce "$VPS_APP_DIR"

          echo "[4/7] Building new containers (no cache)"
          docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" build --no-cache

          echo "[5/7] Starting stack"
          docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d --force-recreate --remove-orphans

          echo "[6/7] Running Prisma migrations"
          if docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" ps backend >/dev/null 2>&1; then
            docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" exec -T backend sh -lc \
              'npx prisma generate && npx prisma migrate deploy || true'
          fi

          echo "[7/7] Deployment completed successfully!"
          docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" ps
          EOF
