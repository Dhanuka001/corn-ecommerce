name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-to-vps
  cancel-in-progress: true

env:
  REPO_URL: https://github.com/Dhanuka001/corn-ecommerce.git
  APP_DIR: /opt/app/corn-ecommerce
  COMPOSE_FILE: infra/docker-compose.prod.yml
  BRANCH: main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (for composite actions/tools)
        uses: actions/checkout@v4

      - name: Validate required secrets
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          for var in SERVER_HOST SERVER_USER SSH_PRIVATE_KEY; do
            if [ -z "${!var}" ]; then
              echo "::error::Environment secret '$var' is missing."
              exit 1
            fi
          done

      - name: Add VPS host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${SERVER_HOST}" >> ~/.ssh/known_hosts
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          REPO_URL: ${{ env.REPO_URL }}
          APP_DIR: ${{ env.APP_DIR }}
          COMPOSE_FILE: ${{ env.COMPOSE_FILE }}
          BRANCH: ${{ env.BRANCH }}
        run: |
          ssh -o StrictHostKeyChecking=yes \
              -p "${SERVER_PORT:-22}" \
              "${SERVER_USER}@${SERVER_HOST}" \
              "REPO_URL='${REPO_URL}' APP_DIR='${APP_DIR}' COMPOSE_FILE='${COMPOSE_FILE}' BRANCH='${BRANCH}' bash -s" <<'EOF'
          set -euo pipefail

          REPO_URL="${REPO_URL}"
          APP_DIR="${APP_DIR}"
          COMPOSE_FILE="${COMPOSE_FILE}"
          BRANCH="${BRANCH}"

          mkdir -p "$APP_DIR"

          if [ ! -d "$APP_DIR/.git" ]; then
            rm -rf "$APP_DIR"
            git clone --depth=1 "$REPO_URL" "$APP_DIR"
          fi

          cd "$APP_DIR"
          git fetch origin "$BRANCH"
          git reset --hard "origin/$BRANCH"
          git clean -fdx

          docker compose -f "$COMPOSE_FILE" pull
          docker compose -f "$COMPOSE_FILE" build --pull --no-cache
          docker compose -f "$COMPOSE_FILE" up -d --force-recreate --remove-orphans
          docker compose -f "$COMPOSE_FILE" ps
          EOF
