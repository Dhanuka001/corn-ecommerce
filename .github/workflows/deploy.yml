name: Deploy to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare SSH (key + known_hosts)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ci
          chmod 600 ~/.ssh/id_ci
          PORT="${{ secrets.VPS_SSH_PORT }}"
          [ -z "$PORT" ] && PORT=22
          ssh-keyscan -p "$PORT" -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH (safe clone + build + restart)
        env:
          VPS_HOST:     ${{ secrets.VPS_HOST }}
          VPS_USER:     ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_APP_DIR:  ${{ secrets.VPS_APP_DIR }}   # /opt/app
          GIT_BRANCH:   ${{ secrets.GIT_BRANCH }}    # main
        run: |
          PORT="${VPS_SSH_PORT:-22}"

          ssh -i ~/.ssh/id_ci -o StrictHostKeyChecking=yes -p "$PORT" \
            "$VPS_USER@$VPS_HOST" \
            "VPS_APP_DIR='${VPS_APP_DIR:-/opt/app}' GIT_BRANCH='${GIT_BRANCH:-main}' bash -s" <<'EOF'
          set -euo pipefail

          : "${VPS_APP_DIR:=/opt/app}"
          : "${GIT_BRANCH:=main}"

          echo "[1/6] Checking repo state"
          if [ ! -d "$VPS_APP_DIR/.git" ]; then
            echo "⚠️  No git repository found. Cloning fresh..."
            rm -rf "$VPS_APP_DIR"
            git clone -b "$GIT_BRANCH" https://github.com/Dhanuka001/corn-ecommerce "$VPS_APP_DIR"
            cd "$VPS_APP_DIR"
          else
            echo "✔ Repo exists — pulling latest"
            cd "$VPS_APP_DIR"
            git fetch origin "$GIT_BRANCH"
            git reset --hard "origin/$GIT_BRANCH"
          fi

          echo "[2/6] Going to infra folder"
          cd "$VPS_APP_DIR/infra"

          echo "[3/6] Stopping old containers"
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          docker network rm corn-ecommerce_web || true

          echo "[4/6] Building new containers"
          docker compose -f docker-compose.prod.yml build

          echo "[5/6] Starting stack"
          docker compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

          echo "[6/6] Running Prisma migrations"
          if docker compose -f docker-compose.prod.yml ps backend >/dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml exec -T backend sh -lc \
              'npx prisma generate && npx prisma migrate deploy || true'
          fi

          echo "Deployment completed successfully!"
          docker compose -f docker-compose.prod.yml ps
          EOF
