generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Test {
  id        Int      @id @default(autoincrement())
  message   String
  createdAt DateTime @default(now())
}

enum Role {
  CUSTOMER
  STAFF
  ADMIN
}

enum PaymentMethod {
  COD
  PAYHERE
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIAL
  REFUNDED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  FULFILLED
  REFUNDED
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String?
  googleId       String?         @unique
  avatarUrl      String?
  firstName      String?
  lastName       String?
  phone          String?
  role           Role            @default(CUSTOMER)
  suspended      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  addresses      Address[]
  orders         Order[]
  cart           Cart?
  favorites      Favorite[]
  productReviews ProductReview[]
  auditLogs      AuditLog[]
}

model Address {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  fullName       String
  phone          String
  addressLine1   String
  addressLine2   String?
  city           String
  district       String
  postalCode     String?
  country        String   @default("LK")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  shippingOrders Order[]  @relation("OrderShip")
  billingOrders  Order[]  @relation("OrderBill")
}

model Order {
  id             String          @id @default(cuid())
  orderNo        String          @unique
  idempotencyKey String?         @unique
  userId         String?
  user           User?           @relation(fields: [userId], references: [id])
  status         OrderStatus     @default(PENDING)
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus   @default(UNPAID)
  items          OrderItem[]
  shippingAddrId String
  shippingAddr   Address         @relation("OrderShip", fields: [shippingAddrId], references: [id])
  billingAddrId  String
  billingAddr    Address         @relation("OrderBill", fields: [billingAddrId], references: [id])
  subTotalLKR    Int
  shippingLKR    Int
  discountLKR    Int
  totalLKR       Int
  payhereRef     String?
  timeline       OrderEvent[]
  payment        Payment?
  productReviews ProductReview[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?    @unique
  user      User?      @relation(fields: [userId], references: [id])
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  qty       Int
  unitLKR   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])
  variant   Variant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([cartId])
}

model Category {
  id        String              @id @default(cuid())
  slug      String              @unique
  name      String
  parentId  String?
  parent    Category?           @relation("CatToParent", fields: [parentId], references: [id])
  children  Category[]          @relation("CatToParent")
  position  Int                 @default(0)
  products  ProductOnCategory[]
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
}

model Product {
  id             String              @id @default(cuid())
  slug           String              @unique
  name           String
  sku            String              @unique
  description    String?
  priceLKR       Int
  compareAtLKR   Int?
  active         Boolean             @default(true)
  stock          Int                 @default(0)
  images         ProductImage[]
  variants       Variant[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
  favorites      Favorite[]
  categories     ProductOnCategory[]
  productReviews ProductReview[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

model Variant {
  id         String      @id @default(cuid())
  productId  String
  product    Product     @relation(fields: [productId], references: [id])
  name       String
  sku        String      @unique
  priceLKR   Int
  stock      Int         @default(0)
  cartItems  CartItem[]
  orderItems OrderItem[]
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  url       String
  alt       String?
  position  Int     @default(0)
}

model ProductReview {
  id        String   @id @default(cuid())
  productId String
  userId    String
  orderId   String
  rating    Int
  title     String
  body      String
  images    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@unique([userId, productId])
  @@index([productId])
  @@index([userId])
}

model ProductOnCategory {
  productId  String
  categoryId String
  product    Product  @relation(fields: [productId], references: [id])
  category   Category @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
}

model OrderItem {
  id           String   @id @default(cuid())
  orderId      String
  productId    String
  variantId    String?
  name         String
  sku          String
  qty          Int
  unitLKR      Int
  lineTotalLKR Int
  order        Order    @relation(fields: [orderId], references: [id])
  product      Product  @relation(fields: [productId], references: [id])
  variant      Variant? @relation(fields: [variantId], references: [id])
}

model Payment {
  id          String        @id @default(cuid())
  orderId     String        @unique
  order       Order         @relation(fields: [orderId], references: [id])
  method      PaymentMethod
  status      PaymentStatus
  amountLKR   Int
  providerRef String?
  rawPayload  Json?
  createdAt   DateTime      @default(now())
}

model OrderEvent {
  id        String   @id @default(cuid())
  orderId   String
  type      String
  note      String?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])
}

model ShippingZone {
  id        String         @id @default(cuid())
  name      String
  districts String[]
  rates     ShippingRate[]
}

model ShippingRate {
  id             String       @id @default(cuid())
  zoneId         String
  zone           ShippingZone @relation(fields: [zoneId], references: [id])
  minSubtotalLKR Int          @default(0)
  priceLKR       Int
  label          String
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  route     String
  method    String
  action    String?
  before    Json?
  after     Json?
  createdAt DateTime @default(now())
}

model StoreSetting {
  id                    Int      @id @default(1)
  codEnabled            Boolean  @default(true)
  payhereMerchantId     String?
  payhereMerchantSecret String?
  payhereSandbox        Boolean  @default(true)
  shippingNotes         String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
